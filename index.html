<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Banana Messaging üçå</title>
<style>
body{margin:0;font-family:Segoe UI;background:#f2f3f5;height:100vh}
.hidden{display:none!important}
#loginPage{height:100vh;display:flex;align-items:center;justify-content:center}
#loginBox{background:#fff;padding:30px;width:320px;border-radius:14px;box-shadow:0 15px 40px rgba(0,0,0,.15);text-align:center}
#loginBox input,#loginBox button{width:100%;padding:11px;margin-top:10px;font-size:14px}
#loginBox button{background:#ffb347;border:none;color:#fff;border-radius:8px;cursor:pointer}
.resetBtn{background:#ff4d4d!important}
#popup{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:10px 18px;border-radius:8px;display:none;z-index:999}
#app{display:none;height:100vh;display:flex}
#sidebar{width:280px;background:#fff;border-right:1px solid #ddd;padding:12px;overflow-y:auto}
#chat{flex:1;display:flex;flex-direction:column}
#top{background:#ffb347;color:white;padding:12px;font-weight:600}
#messages{flex:1;overflow-y:auto;padding:14px;list-style:none}
#messages li{background:#fff;padding:10px;margin-bottom:8px;border-radius:12px;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
#typingBar{font-size:12px;color:#666;padding:4px 14px;height:18px}
#sendBar{padding:10px;background:#eee}
#sendBar input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc}
.smallBtn{font-size:11px;margin-left:6px}
.panel{background:#fafafa;border:1px solid #ddd;padding:8px;margin-bottom:12px;border-radius:8px}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}
.online{background:#3ccf4e}
.offline{background:#bbb}
.time{font-size:10px;color:#999;margin-left:6px}
</style>
</head>
<body>

<div id="popup"></div>

<div id="loginPage">
  <div id="loginBox">
    <h3>üçå Banana Messaging</h3>
    <input id="u" placeholder="Username">
    <input id="p" type="password" placeholder="Password">
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Login</button>
    <button class="resetBtn" id="resetBtn">üö® Emergency Reset</button>
  </div>
</div>

<div id="app">
  <div id="sidebar">
    <button onclick="openGlobal()">üåç Global</button>
    <button onclick="createGroup()">‚ûï Create Group</button>
    <div id="adminPanel"></div>
    <div id="groupAdmin"></div>
    <h4>Users</h4>
    <div id="users"></div>
    <h4>Groups</h4>
    <div id="groups"></div>
  </div>
  <div id="chat">
    <div id="top"><span id="title">Global</span></div>
    <ul id="messages"></ul>
    <div id="typingBar"></div>
    <div id="sendBar">
      <input id="msg" placeholder="Type message & press Enter">
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>

<script>
window.onload = function(){
const loginPage=document.getElementById("loginPage");
const app=document.getElementById("app");
const adminPanel=document.getElementById("adminPanel");
const groupAdmin=document.getElementById("groupAdmin");
const users=document.getElementById("users");
const groups=document.getElementById("groups");
const messages=document.getElementById("messages");
const msg=document.getElementById("msg");
const typingBar=document.getElementById("typingBar");
const popupBox=document.getElementById("popup");
const title=document.getElementById("title");
const u=document.getElementById("u");
const p=document.getElementById("p");

firebase.initializeApp({
  apiKey:"AIzaSyBw24k2FBeJJm_weANCnbdxmPbCHXNKI6I",
  databaseURL:"https://bananamessagingsite-default-rtdb.firebaseio.com"
});
const db=firebase.database();
const MAIN_ADMIN="banana777";

let user=null, chat="global", msgRef=null, currentGroup=null;

const hash=t=>[...t].reduce((h,c)=>((h<<5)+h)+c.charCodeAt(0),5381).toString();
const popup=t=>{popupBox.textContent=t; popupBox.style.display="block"; setTimeout(()=>popupBox.style.display="none",2200);};

async function signup(){
  if(!u.value||!p.value) return popup("Fill fields");
  if((await db.ref("users/"+u.value).once("value")).exists()) return popup("User exists");
  await db.ref("users/"+u.value).set({password:hash(p.value),banned:false});
  start(u.value);
}
async function loginUser(){
  const s=await db.ref("users/"+u.value).once("value");
  if(!s.exists()) return popup("No user");
  if(s.val().banned) return popup("You are banned");
  if(hash(p.value)!==s.val().password) return popup("Wrong password");
  start(u.value);
}
function start(n){
  user=n;
  loginPage.classList.add("hidden");
  app.style.display="flex";
  db.ref("online/"+user).set(true);
  db.ref("online/"+user).onDisconnect().remove();
  if(user===MAIN_ADMIN) loadAdminPanel();
  openGlobal(); loadUsers(); loadGroups();
}

document.getElementById("signupBtn").onclick=signup;
document.getElementById("loginBtn").onclick=loginUser;
document.getElementById("resetBtn").onclick=async()=>{
  if(prompt("PIN")!=="0000") return; await db.ref().remove(); location.reload();
};

/* ADMIN */
function loadAdminPanel(){
  db.ref("users").on("value",s=>{
    let h='<div class="panel"><b>üëë Main Admin</b><br>';
    s.forEach(c=>{
      if(c.key===user) return;
      h+=`${c.key} <button class="smallBtn" onclick="db.ref('users/${c.key}/banned').set(${!c.val().banned})">${c.val().banned?'Unban':'Ban'}</button><br>`;
    });
    adminPanel.innerHTML=h+"</div>";
  });
}

/* USERS */
function loadUsers(){
  db.ref("users").on("value",uSnap=>{
    db.ref("online").on("value",oSnap=>{
      users.innerHTML="";
      uSnap.forEach(c=>{
        if(c.key===user) return;
        users.innerHTML+=`<div><span class="dot ${oSnap.val()?.[c.key]?'online':'offline'}"></span> ${c.key} <button class="smallBtn" onclick="openDM('${c.key}')">DM</button></div>`;
      });
    });
  });
}

/* GROUPS */
function createGroup(){
  const name=prompt("Group name?");
  if(!name) return;
  db.ref("groups/g"+Date.now()).set({name,owner:user,members:{[user]:true},requests:{}});
}
function loadGroups(){
  db.ref("groups").on("value",s=>{
    groups.innerHTML="";
    s.forEach(c=>{
      const g=c.val();
      groups.innerHTML+=`<div>${g.name} ${g.members?.[user]?`<button onclick="openGroup('${c.key}','${g.name}')">Open</button>`:`<button onclick="requestJoin('${c.key}')">Request</button>`}</div>`;
    });
  });
}
function requestJoin(id){db.ref("groups/"+id+"/requests/"+user).set(true); popup("Request sent");}

/* GROUP PANEL */
function loadGroupPanel(){
  db.ref("groups/"+currentGroup).on("value",s=>{
    const g=s.val(); if(!g){groupAdmin.innerHTML="";return;}
    const isAdmin=g.owner===user||user===MAIN_ADMIN;
    let h='<div class="panel"><b>Group</b><br><b>Members</b><br>';
    Object.keys(g.members||{}).forEach(m=>{
      h+=`${m} ${isAdmin&&m!==user?`<button class="smallBtn" onclick="kick('${m}')">Kick</button>`:""}<br>`;
    });
    if(isAdmin){
      h+="<hr><b>Requests</b><br>";
      Object.keys(g.requests||{}).forEach(r=>{
        h+=`${r} <button class="smallBtn" onclick="approve('${r}')">‚úî</button> <button class="smallBtn" onclick="reject('${r}')">‚úñ</button><br>`;
      });
      h+=`<hr><button class="resetBtn" onclick="deleteGroup()">Delete Group</button>`;
    }
    groupAdmin.innerHTML=h+"</div>";
  });
}
window.approve=u=>{db.ref("groups/"+currentGroup+"/members/"+u).set(true); db.ref("groups/"+currentGroup+"/requests/"+u).remove();}
window.reject=u=>{db.ref("groups/"+currentGroup+"/requests/"+u).remove();}
window.kick=u=>{db.ref("groups/"+currentGroup+"/members/"+u).remove();}
window.deleteGroup=()=>{if(confirm("Delete group forever?")) db.ref("groups/"+currentGroup).remove();}

/* CHAT NAV */
window.openGlobal=()=>{
  chat="global"; currentGroup=null; title.textContent="Global"; groupAdmin.innerHTML=""; loadMessages();
};
window.openGroup=(id,name)=>{
  chat="groups/"+id; currentGroup=id; title.textContent=name; loadMessages(); loadGroupPanel();
};
window.openDM=o=>{
  chat="dm/"+[user,o].sort().join("_"); currentGroup=null; title.textContent="DM "+o; groupAdmin.innerHTML=""; loadMessages();
};

/* MESSAGES */
function loadMessages(){
  if(msgRef) msgRef.off();
  messages.innerHTML="";
  msgRef=db.ref("messages/"+chat).limitToLast(100);
  msgRef.on("child_added",s=>{
    const d=s.val();
    const li=document.createElement("li"); li.id=s.key;
    li.innerHTML=`<b>${d.user}</b>: ${d.text} <span class="time">${new Date(d.time).toLocaleTimeString()}</span> ${(d.user===user||user===MAIN_ADMIN)?`<button class="smallBtn" onclick="deleteMsg('${s.key}')">üóë</button>`:""}`;
    messages.appendChild(li); messages.scrollTop=messages.scrollHeight;
  });
  msgRef.on("child_removed",s=>{document.getElementById(s.key)?.remove();});
}
window.deleteMsg=id=>{db.ref("messages/"+chat+"/"+id).remove();}

/* TYPING */
msg.oninput=()=>{
  db.ref("typing/"+chat+"/"+user).set(true);
  clearTimeout(window._t);
  window._t=setTimeout(()=>db.ref("typing/"+chat+"/"+user).remove(),1200);
};
db.ref("typing").on("value",s=>{
  const t=Object.keys(s.val()?.[chat]||{}).filter(x=>x!==user);
  typingBar.textContent=t.length?`${t.join(", ")} typing‚Ä¶`:"";
});

/* SEND */
msg.onkeydown=e=>{
  if(e.key==="Enter" && msg.value.trim()){
    db.ref("messages/"+chat).push({user,text:msg.value,time:Date.now()});
    db.ref("typing/"+chat+"/"+user).remove();
    msg.value="";
  }
};
}
</script>
</body>
</html>
