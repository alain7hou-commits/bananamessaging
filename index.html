<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Messaging üçå</title>
    <style>
        :root {
            --primary: #ffb347;
            --bg: #1a1a1a;
            --sidebar-bg: #252525;
            --text: #ffffff;
            --secondary-text: #b3b3b3;
            --accent: #ffcc33;
            --danger: #ff5555;
            --msg-bg: #333;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* Login Screen */
        #loginPage {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
        }

        #loginBox {
            background: var(--sidebar-bg);
            padding: 40px;
            width: 350px;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            text-align: center;
        }

        #loginBox h3 { font-size: 24px; margin-bottom: 20px; color: var(--primary); }

        input {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #111;
            color: white;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: var(--primary);
            border: none;
            color: #000;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.98); }

        .resetBtn { background: transparent !important; color: var(--danger); border: 1px solid var(--danger) !important; margin-top: 25px; }

        /* Main App Layout */
        #app { display: none; height: 100vh; flex-direction: row; }

        #sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        #sidebar h4 { color: var(--secondary-text); margin-top: 25px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }

        .list-container { flex: 1; overflow-y: auto; }

        /* Chat Area */
        #chat { flex: 1; display: flex; flex-direction: column; background: var(--bg); }

        #top {
            background: var(--sidebar-bg);
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            color: var(--primary);
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg-item {
            background: var(--msg-bg);
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 70%;
            align-self: flex-start;
            position: relative;
        }

        .msg-item.me {
            background: var(--primary);
            color: black;
            align-self: flex-end;
        }

        .msg-user { font-size: 11px; margin-bottom: 4px; display: block; opacity: 0.7; }

        #sendBar {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: var(--sidebar-bg);
        }

        #msg { margin-top: 0; }

        .smallBtn {
            width: auto;
            padding: 4px 8px;
            font-size: 11px;
            margin-left: 5px;
            display: inline-block;
        }

        .user-row { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
    </style>
</head>

<body>

<div id="loginPage">
    <div id="loginBox">
        <h3>üçå Banana Messaging</h3>
        <input id="u" placeholder="Username">
        <input id="p" type="password" placeholder="Password">
        <button onclick="loginUser()">Login</button>
        <button style="background:#555; color:white" onclick="signup()">Create Account</button>
        <button class="resetBtn" onclick="loginEmergencyReset()">üö® Emergency Reset</button>
        <div id="banMsg" class="notice hidden" style="color:red; margin-top:10px;">üö´ YOU ARE BANNED</div>
    </div>
</div>

<div id="app">
    <div id="sidebar">
        <button onclick="openGlobal()">üåç Global Chat</button>
        <button style="background:#444; color:white" onclick="createGroup()">‚ûï New Group</button>

        <h4>Users</h4>
        <div id="users" class="list-container"></div>

        <h4>Groups</h4>
        <div id="groups" class="list-container"></div>

        <hr style="width:100%; border:0; border-top:1px solid #444; margin: 20px 0;">
        <button class="resetBtn" style="margin-top:0" onclick="deleteMe()">Delete Account</button>
    </div>

    <div id="chat">
        <div id="top"><span id="title">Global</span></div>
        <ul id="messages"></ul>
        <div id="sendBar">
            <input id="msg" placeholder="Type a message...">
            <button onclick="send()" style="width:80px; margin-top:0">Send</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>

<script>
    // --- DATABASE CONFIG ---
    // Note: In a real app, never share your API keys publicly!
    const firebaseConfig = {
        apiKey: "AIzaSyBw24k2FBeJJm_weANCnbdxmPbCHXNKI6I",
        databaseURL: "https://bananamessagingsite-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MAIN_ADMIN = "banana777";
    let currentUser = null;
    let currentChatPath = "global";
    let msgRef = null;
    let isAdmin = false;

    // --- UTILS ---
    const badWords = ["fuck", "shit", "bitch", "asshole"]; // Expand as needed
    function filterText(t) {
        let clean = t;
        badWords.forEach(w => {
            const reg = new RegExp(w, "gi");
            clean = clean.replace(reg, "***");
        });
        return clean;
    }

    function hash(t) {
        let h = 5381;
        for (let i = 0; i < t.length; i++) h = ((h << 5) + h) + t.charCodeAt(i);
        return h.toString();
    }

    // --- AUTH ---
    async function signup() {
        const u = document.getElementById('u').value.trim();
        const p = document.getElementById('p').value.trim();
        if (!u || !p) return alert("Enter username and password");
        
        const snapshot = await db.ref("users/" + u).once("value");
        if (snapshot.exists()) return alert("Username taken!");

        await db.ref("users/" + u).set({
            password: hash(p),
            banned: false
        });
        startApp(u);
    }

    async function loginUser() {
        const u = document.getElementById('u').value.trim();
        const p = document.getElementById('p').value.trim();
        const snapshot = await db.ref("users/" + u).once("value");
        
        if (!snapshot.exists()) return alert("User not found");
        const userData = snapshot.val();
        
        if (userData.banned) {
            document.getElementById('banMsg').classList.remove("hidden");
            return;
        }
        if (hash(p) !== userData.password) return alert("Wrong password");
        
        startApp(u);
    }

    function startApp(username) {
        currentUser = username;
        isAdmin = (currentUser === MAIN_ADMIN);
        document.getElementById('loginPage').classList.add("hidden");
        document.getElementById('app').style.display = "flex";
        
        openGlobal();
        loadSidebarData();
    }

    // --- SIDEBAR ---
    function loadSidebarData() {
        // Load Users
        db.ref("users").on("value", s => {
            const userDiv = document.getElementById('users');
            userDiv.innerHTML = "";
            s.forEach(child => {
                if (child.key === currentUser) return;
                const isUserBanned = child.val().banned;
                userDiv.innerHTML += `
                    <div class="user-row">
                        <span>${child.key}</span>
                        <div>
                            <button class="smallBtn" onclick="openDM('${child.key}')">DM</button>
                            ${isAdmin ? `<button class="smallBtn" style="background:red" onclick="toggleBan('${child.key}', ${!isUserBanned})">${isUserBanned?'Unban':'Ban'}</button>` : ''}
                        </div>
                    </div>`;
            });
        });

        // Load Groups
        db.ref("groups").on("value", s => {
            const groupDiv = document.getElementById('groups');
            groupDiv.innerHTML = "";
            s.forEach(child => {
                const g = child.val();
                const isMember = g.members && g.members[currentUser];
                groupDiv.innerHTML += `
                    <div class="user-row">
                        <span>${g.name}</span>
                        <button class="smallBtn" onclick="${isMember ? `openGroup('${child.key}','${g.name}')` : `joinGroup('${child.key}')`}">
                            ${isMember ? 'Open' : 'Join'}
                        </button>
                    </div>`;
            });
        });
    }

    // --- CHAT LOGIC ---
    function openGlobal() {
        currentChatPath = "global";
        document.getElementById('title').textContent = "üåç Global Chat";
        loadMessages();
    }

    function openDM(otherUser) {
        currentChatPath = "dm/" + [currentUser, otherUser].sort().join("_");
        document.getElementById('title').textContent = "üí¨ Chat with " + otherUser;
        loadMessages();
    }

    function openGroup(id, name) {
        currentChatPath = "groups/" + id;
        document.getElementById('title').textContent = "üë• " + name;
        loadMessages();
    }

    function loadMessages() {
        if (msgRef) msgRef.off();
        const msgList = document.getElementById('messages');
        msgList.innerHTML = "";
        
        msgRef = db.ref("messages/" + currentChatPath);
        msgRef.on("child_added", s => {
            const data = s.val();
            const isMe = data.user === currentUser;
            const li = document.createElement('li');
            li.className = `msg-item ${isMe ? 'me' : ''}`;
            li.innerHTML = `<span class="msg-user">${data.user}</span>${data.text}`;
            msgList.appendChild(li);
            msgList.scrollTop = msgList.scrollHeight;
        });
    }

    function send() {
        const input = document.getElementById('msg');
        const val = input.value.trim();
        if (!val) return;
        
        db.ref("messages/" + currentChatPath).push({
            user: currentUser,
            text: filterText(val),
            timestamp: Date.now()
        });
        input.value = "";
    }

    // Enter key support
    document.getElementById('msg').addEventListener("keypress", e => {
        if (e.key === "Enter") send();
    });

    // --- ACTIONS ---
    function toggleBan(u, status) { db.ref("users/" + u + "/banned").set(status); }
    function joinGroup(id) { db.ref("groups/" + id + "/members/" + currentUser).set(true); }
    
    function createGroup() {
        const name = prompt("Group Name?");
        if (!name) return;
        const id = "group_" + Date.now();
        db.ref("groups/" + id).set({
            name: name,
            owner: currentUser,
            members: { [currentUser]: true }
        });
    }

    function deleteMe() {
        if (confirm("Permanently delete your account?")) {
            db.ref("users/" + currentUser).remove();
            location.reload();
        }
    }

    async function loginEmergencyReset() {
        const p = prompt("Enter Emergency Reset Pin (Default 0000):");
        if (p === "0000") {
            if (confirm("WARNING: This will wipe the ENTIRE database. Continue?")) {
                await db.ref().remove();
                location.reload();
            }
        } else {
            alert("Incorrect Pin");
        }
    }
</script>

</body>
</html>
