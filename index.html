<script>
firebase.initializeApp({
  apiKey:"AIzaSyBw24k2FBeJJm_weANCnbdxmPbCHXNKI6I",
  databaseURL:"https://bananamessagingsite-default-rtdb.firebaseio.com"
});
const db=firebase.database();
const MAIN_ADMIN="banana777";

let user=null, chat="global", msgRef=null, currentGroup=null;

/* helpers */
const hash=t=>[...t].reduce((h,c)=>((h<<5)+h)+c.charCodeAt(0),5381).toString();
const popup=t=>{
  popupBox.textContent=t;
  popupBox.style.display="block";
  setTimeout(()=>popupBox.style.display="none",2200);
};

/* AUTH */
async function signup(){
  if(!u.value||!p.value) return popup("Fill fields");
  if((await db.ref("users/"+u.value).once("value")).exists()) return popup("User exists");
  await db.ref("users/"+u.value).set({password:hash(p.value),banned:false});
  start(u.value);
}
async function loginUser(){
  const s=await db.ref("users/"+u.value).once("value");
  if(!s.exists()) return popup("No user");
  if(s.val().banned) return popup("You are banned");
  if(hash(p.value)!==s.val().password) return popup("Wrong password");
  start(u.value);
}
function start(n){
  user=n;
  loginPage.classList.add("hidden");
  app.style.display="flex";

  db.ref("online/"+user).set(true);
  db.ref("online/"+user).onDisconnect().remove();

  if(user===MAIN_ADMIN) loadAdminPanel();
  openGlobal(); loadUsers(); loadGroups();
}

/* ADMIN PANEL (MAIN ADMIN ONLY) */
function loadAdminPanel(){
  db.ref("users").on("value",s=>{
    let h='<div class="panel"><b>ðŸ‘‘ Main Admin</b><br>';
    s.forEach(c=>{
      if(c.key===user) return;
      h+=`${c.key}
      <button class="smallBtn"
        onclick="db.ref('users/${c.key}/banned').set(${!c.val().banned})">
        ${c.val().banned?'Unban':'Ban'}
      </button><br>`;
    });
    adminPanel.innerHTML=h+"</div>";
  });
}

/* USERS */
function loadUsers(){
  db.ref("users").on("value",uSnap=>{
    db.ref("online").on("value",oSnap=>{
      users.innerHTML="";
      uSnap.forEach(c=>{
        if(c.key===user) return;
        users.innerHTML+=`
        <div>
          <span class="dot ${oSnap.val()?.[c.key]?'online':'offline'}"></span>
          ${c.key}
          <button class="smallBtn" onclick="openDM('${c.key}')">DM</button>
        </div>`;
      });
    });
  });
}

/* GROUPS */
function createGroup(){
  const name=prompt("Group name?");
  if(!name) return;
  db.ref("groups/g"+Date.now()).set({
    name,
    owner:user,
    members:{[user]:true},
    requests:{}
  });
}
function loadGroups(){
  db.ref("groups").on("value",s=>{
    groups.innerHTML="";
    s.forEach(c=>{
      const g=c.val();
      groups.innerHTML+=`
      <div>${g.name}
        ${g.members?.[user]
          ? `<button onclick="openGroup('${c.key}','${g.name}')">Open</button>`
          : `<button onclick="requestJoin('${c.key}')">Request</button>`}
      </div>`;
    });
  });
}
function requestJoin(id){
  db.ref("groups/"+id+"/requests/"+user).set(true);
  popup("Request sent");
}

/* GROUP PANEL */
function loadGroupPanel(){
  const panel=document.getElementById("groupAdmin");
  db.ref("groups/"+currentGroup).on("value",s=>{
    const g=s.val(); if(!g){panel.innerHTML="";return;}
    const isAdmin=g.owner===user||user===MAIN_ADMIN;

    let h='<div class="panel"><b>Group</b><br>';

    h+="<b>Members</b><br>";
    Object.keys(g.members||{}).forEach(m=>{
      h+=`${m} ${isAdmin&&m!==user?
        `<button class="smallBtn" onclick="kick('${m}')">Kick</button>`:""}<br>`;
    });

    if(isAdmin){
      h+="<hr><b>Requests</b><br>";
      Object.keys(g.requests||{}).forEach(r=>{
        h+=`${r}
        <button class="smallBtn" onclick="approve('${r}')">âœ”</button>
        <button class="smallBtn" onclick="reject('${r}')">âœ–</button><br>`;
      });
      h+=`<hr><button class="resetBtn" onclick="deleteGroup()">Delete Group</button>`;
    }
    panel.innerHTML=h+"</div>";
  });
}
function approve(u){
  db.ref("groups/"+currentGroup+"/members/"+u).set(true);
  db.ref("groups/"+currentGroup+"/requests/"+u).remove();
}
function reject(u){db.ref("groups/"+currentGroup+"/requests/"+u).remove();}
function kick(u){db.ref("groups/"+currentGroup+"/members/"+u).remove();}
function deleteGroup(){
  if(confirm("Delete group forever?")) db.ref("groups/"+currentGroup).remove();
}

/* CHAT NAV */
function openGlobal(){
  chat="global"; currentGroup=null;
  title.textContent="Global";
  groupAdmin.innerHTML="";
  loadMessages();
}
function openGroup(id,name){
  chat="groups/"+id;
  currentGroup=id;
  title.textContent=name;
  loadMessages();
  loadGroupPanel();
}
function openDM(o){
  chat="dm/"+[user,o].sort().join("_");
  currentGroup=null;
  title.textContent="DM "+o;
  groupAdmin.innerHTML="";
  loadMessages();
}

/* MESSAGES */
function loadMessages(){
  if(msgRef) msgRef.off();
  messages.innerHTML="";
  msgRef=db.ref("messages/"+chat).limitToLast(100);

  msgRef.on("child_added",s=>{
    const d=s.val();
    const li=document.createElement("li");
    li.id=s.key;
    li.innerHTML=`
      <b>${d.user}</b>: ${d.text}
      <span class="time">${new Date(d.time).toLocaleTimeString()}</span>
      ${(d.user===user||user===MAIN_ADMIN)?
        `<button class="smallBtn" onclick="deleteMsg('${s.key}')">ðŸ—‘</button>`:""}
    `;
    messages.appendChild(li);
    messages.scrollTop=messages.scrollHeight;
  });

  msgRef.on("child_removed",s=>{
    document.getElementById(s.key)?.remove();
  });
}
function deleteMsg(id){
  db.ref("messages/"+chat+"/"+id).remove();
}

/* TYPING */
msg.oninput=()=>{
  db.ref("typing/"+chat+"/"+user).set(true);
  clearTimeout(window._t);
  window._t=setTimeout(()=>db.ref("typing/"+chat+"/"+user).remove(),1200);
};
db.ref("typing").on("value",s=>{
  const t=Object.keys(s.val()?.[chat]||{}).filter(x=>x!==user);
  typingBar.textContent=t.length?`${t.join(", ")} typingâ€¦`:"";
});

/* SEND */
msg.onkeydown=e=>{
  if(e.key==="Enter" && msg.value.trim()){
    db.ref("messages/"+chat).push({
      user,text:msg.value,time:Date.now()
    });
    db.ref("typing/"+chat+"/"+user).remove();
    msg.value="";
  }
};
</script>
