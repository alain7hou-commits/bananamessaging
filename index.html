<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Banana Messaging üçå</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f3f3f3;height:100vh}
.hidden{display:none!important}
#loginPage{height:100vh;display:flex;align-items:center;justify-content:center}
#loginBox{background:#fff;padding:30px;width:320px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);text-align:center}
#loginBox input,#loginBox button{width:100%;padding:10px;margin-top:10px}
#loginBox button{background:#ffb347;border:none;color:#fff;border-radius:6px;cursor:pointer}
.resetBtn{background:#ff5555!important}

#app{display:none;height:100vh}
#sidebar{width:260px;background:#fff;border-right:1px solid #ddd;padding:10px;overflow-y:auto}
#chat{flex:1;display:flex;flex-direction:column}
#top{background:#ffb347;color:white;padding:10px;font-weight:bold}
#messages{flex:1;overflow-y:auto;padding:10px;list-style:none}
#messages li{background:#fff;padding:8px;margin-bottom:6px;border-radius:6px}
#sendBar{display:flex;gap:6px;padding:8px;background:#eee}
#sendBar input{flex:1;padding:8px}
.smallBtn{font-size:11px;margin-left:4px}
.notice{color:red;font-weight:bold;margin-top:10px}
#typing{font-size:12px;color:#555;padding:0 10px}
</style>
</head>

<body>

<div id="loginPage">
  <div id="loginBox">
    <h3>üçå Banana Messaging</h3>
    <input id="u" placeholder="Username">
    <input id="p" type="password" placeholder="Password">
    <button onclick="signup()">Sign Up</button>
    <button onclick="loginUser()">Login</button>
    <button class="resetBtn" onclick="loginEmergencyReset()">üö® Emergency Reset</button>
    <div id="banMsg" class="notice hidden">üö´ YOU ARE BANNED</div>
  </div>
</div>

<div id="app">
  <div id="sidebar">
    <button onclick="openGlobal()">üåç Global</button>
    <button onclick="createGroup()">‚ûï Create Group</button>

    <h4>Users</h4>
    <div id="users"></div>

    <h4>Groups</h4>
    <div id="groups"></div>

    <hr>
    <button onclick="deleteMe()">‚ùå Delete My Account</button>
    <button onclick="emergencyReset()">üö® Emergency Reset</button>
  </div>

  <div id="chat">
    <div id="top"><span id="title">Global</span></div>
    <ul id="messages"></ul>
    <div id="typing"></div>
    <div id="sendBar">
      <input id="msg" placeholder="Type a message">
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBw24k2FBeJJm_weANCnbdxmPbCHXNKI6I",
  databaseURL:"https://bananamessagingsite-default-rtdb.firebaseio.com"
});
const db=firebase.database();

const MAIN_ADMIN="banana777";
let user=null,chat="global",msgRef=null,isAdmin=false,currentGroup=null,typingRef=null;

/* BAD WORD FILTER */
const badWords=["fuck","shit","bitch","asshole","cunt","nigger","nigga","retard","fag"];
function filterText(t){
  badWords.forEach(w=>t=t.replace(new RegExp(w,"gi"),"***"));
  return t;
}

/* HASH */
function hash(t){
  let h=5381;
  for(let i=0;i<t.length;i++) h=((h<<5)+h)+t.charCodeAt(i);
  return h.toString();
}

/* SIGNUP */
async function signup(){
  const u=uEl.value,p=pEl.value;
  if(!u||!p) return alert("Fill fields");
  if((await db.ref("users/"+u).once("value")).exists()) return alert("User exists");
  await db.ref("users/"+u).set({password:hash(p),banned:false,admin:false});
  start(u);
}

/* LOGIN */
async function loginUser(){
  const u=uEl.value,p=pEl.value;
  const s=await db.ref("users/"+u).once("value");
  if(!s.exists()) return alert("No user");
  if(s.val().banned){banMsg.classList.remove("hidden");return;}
  if(hash(p)!==s.val().password) return alert("Wrong password");
  start(u);
}

/* START */
function start(n){
  user=n;
  isAdmin=(user===MAIN_ADMIN);
  loginPage.classList.add("hidden");
  app.style.display="flex";
  openGlobal();
  loadUsers();
  loadGroups();
}

/* USERS */
function loadUsers(){
  db.ref("users").on("value",s=>{
    users.innerHTML="";
    s.forEach(c=>{
      if(c.key===user) return;
      users.innerHTML+=`
      <div>${c.key}
        <button class="smallBtn" onclick="openDM('${c.key}')">DM</button>
        ${isAdmin?`
        <button class="smallBtn" onclick="setBan('${c.key}',true)">Ban</button>
        <button class="smallBtn" onclick="setBan('${c.key}',false)">Unban</button>
        <button class="smallBtn" onclick="setAdmin('${c.key}',true)">Promote</button>
        <button class="smallBtn" onclick="setAdmin('${c.key}',false)">Demote</button>`:""}
      </div>`;
    });
  });
}
function setBan(u,v){db.ref("users/"+u+"/banned").set(v);}
function setAdmin(u,v){db.ref("users/"+u+"/admin").set(v);}

/* GROUPS */
function createGroup(){
  const name=prompt("Group name?");
  const open=confirm("OK = Open join\nCancel = Request join");
  db.ref("groups/group_"+Date.now()).set({
    name,owner:user,open,
    admins:{[user]:true},
    members:{[user]:true},
    requests:{}
  });
}
function loadGroups(){
  db.ref("groups").on("value",s=>{
    groups.innerHTML="";
    s.forEach(c=>{
      const g=c.val();
      const joined=g.members && g.members[user];
      groups.innerHTML+=`
      <div>${g.name}
        ${joined?`<button onclick="openGroup('${c.key}','${g.name}')">Open</button>`:
        g.open?`<button onclick="joinGroup('${c.key}')">Join</button>`:
        `<button onclick="requestJoin('${c.key}')">Request</button>`}
      </div>`;
    });
  });
}
function joinGroup(id){db.ref("groups/"+id+"/members/"+user).set(true);}
function requestJoin(id){db.ref("groups/"+id+"/requests/"+user).set(true);}
function openGroup(id,n){
  chat="groups/"+id;
  currentGroup=id;
  title.textContent=n;
  loadMessages();
}

/* CHAT */
function openGlobal(){chat="global";currentGroup=null;title.textContent="Global";loadMessages();}
function openDM(o){chat="dm/"+[user,o].sort().join("_");currentGroup=null;title.textContent="DM "+o;loadMessages();}

/* MESSAGES */
function loadMessages(){
  if(msgRef) msgRef.off();
  messages.innerHTML="";
  msgRef=db.ref("messages/"+chat);
  msgRef.on("child_added",s=>{
    const d=s.val();
    const canDel=(d.user===user||isAdmin);
    messages.innerHTML+=`
    <li id="${s.key}">
      <b>${d.user}</b>: ${d.text}
      ${canDel?`<button class="smallBtn" onclick="deleteMsg('${s.key}')">‚ùå</button>`:""}
    </li>`;
    messages.scrollTop=messages.scrollHeight;
  });
  setupTyping();
}
function deleteMsg(id){db.ref("messages/"+chat+"/"+id).remove();}

/* TYPING INDICATOR (REAL-TIME) */
function setupTyping(){
  if(typingRef) typingRef.off();
  typing.textContent="";
  typingRef=db.ref("typing/"+chat);
  typingRef.on("value",s=>{
    const usersTyping=Object.keys(s.val()||{}).filter(u=>u!==user);
    typing.textContent=usersTyping.length?usersTyping.join(", ")+" typing‚Ä¶":"";
  });
}

msg.addEventListener("input",()=>{
  db.ref("typing/"+chat+"/"+user).set(true);
  clearTimeout(window.t);
  window.t=setTimeout(()=>db.ref("typing/"+chat+"/"+user).remove(),1200);
});

/* SEND */
msg.addEventListener("keydown",e=>{
  if(e.key==="Enter"){e.preventDefault();send();}
});
function send(){
  if(!msg.value.trim()) return;
  db.ref("messages/"+chat).push({user,text:filterText(msg.value)});
  msg.value="";
  db.ref("typing/"+chat+"/"+user).remove();
}

/* RESET + DELETE */
function deleteMe(){if(confirm("Delete account?")){db.ref("users/"+user).remove();location.reload();}}
async function loginEmergencyReset(){
  const p=prompt("Reset code");
  if(p!=="0000") return;
  await db.ref().remove();
  location.reload();
}
function emergencyReset(){loginEmergencyReset();}

const uEl=u,pEl=p;
</script>

</body>
</html>
