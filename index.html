<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Banana Messaging üçå</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f3f3f3;height:100vh}
.hidden{display:none!important}
#loginPage{height:100vh;display:flex;align-items:center;justify-content:center}
#loginBox{background:#fff;padding:30px;width:320px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);text-align:center}
#loginBox input,#loginBox button{width:100%;padding:10px;margin-top:10px}
#loginBox button{background:#ffb347;border:none;color:#fff;border-radius:6px;cursor:pointer}
.resetBtn{background:#ff5555!important}

#app{display:none;height:100vh}
#sidebar{width:260px;background:#fff;border-right:1px solid #ddd;padding:10px;overflow-y:auto}
#chat{flex:1;display:flex;flex-direction:column}
#top{background:#ffb347;color:white;padding:10px;font-weight:bold}
#messages{flex:1;overflow-y:auto;padding:10px;list-style:none}
#messages li{background:#fff;padding:8px;margin-bottom:6px;border-radius:6px;font-size:14px}
#messages img{max-width:200px;border-radius:6px;display:block;margin-top:6px}
#sendBar{display:flex;gap:6px;padding:8px;background:#eee}
#sendBar input{flex:1;padding:8px}
.smallBtn{font-size:11px;margin-left:4px}
.notice{color:red;font-weight:bold;margin-top:10px}
#typing{font-size:12px;color:#555;padding:0 10px}
.time{font-size:10px;color:#888;margin-left:6px}
.panel{background:#fafafa;border:1px solid #ddd;padding:6px;margin-bottom:10px}
</style>
</head>

<body>

<div id="loginPage">
  <div id="loginBox">
    <h3>üçå Banana Messaging</h3>
    <input id="u" placeholder="Username">
    <input id="p" type="password" placeholder="Password">
    <button onclick="signup()">Sign Up</button>
    <button onclick="loginUser()">Login</button>
    <button class="resetBtn" onclick="loginEmergencyReset()">üö® Emergency Reset</button>
    <div id="banMsg" class="notice hidden">üö´ YOU ARE BANNED</div>
  </div>
</div>

<div id="app">
  <div id="sidebar">
    <button onclick="openGlobal()">üåç Global</button>
    <button onclick="createGroup()">‚ûï Create Group</button>

    <div id="adminPanel"></div>
    <div id="groupAdmin"></div>

    <h4>Users</h4>
    <div id="users"></div>

    <h4>Groups</h4>
    <div id="groups"></div>

    <hr>
    <button onclick="deleteMe()">‚ùå Delete My Account</button>
  </div>

  <div id="chat">
    <div id="top"><span id="title">Global</span></div>
    <ul id="messages"></ul>
    <div id="typing"></div>
    <div id="sendBar">
      <input id="msg" placeholder="Type message or image URL">
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBw24k2FBeJJm_weANCnbdxmPbCHXNKI6I",
  databaseURL:"https://bananamessagingsite-default-rtdb.firebaseio.com"
});
const db=firebase.database();
const MAIN_ADMIN="banana777";

let user=null,chat="global",msgRef=null,currentGroup=null,typingRef=null;

/* INIT PIN */
db.ref("settings/emergencyPin").once("value",s=>{
  if(!s.exists()) db.ref("settings/emergencyPin").set("0000");
});

/* AUTH */
const hash=t=>[...t].reduce((h,c)=>((h<<5)+h)+c.charCodeAt(0),5381).toString();

async function signup(){
  if(!u.value||!p.value) return alert("Fill fields");
  if((await db.ref("users/"+u.value).once("value")).exists()) return alert("Exists");
  await db.ref("users/"+u.value).set({password:hash(p.value),banned:false});
  start(u.value);
}

async function loginUser(){
  const s=await db.ref("users/"+u.value).once("value");
  if(!s.exists()) return alert("No user");
  if(s.val().banned) return banMsg.classList.remove("hidden");
  if(hash(p.value)!==s.val().password) return alert("Wrong");
  start(u.value);
}

function start(n){
  user=n;
  loginPage.classList.add("hidden");
  app.style.display="flex";
  if(user===MAIN_ADMIN) loadAdminPanel();
  openGlobal();loadUsers();loadGroups();
}

/* ADMIN PANEL */
function loadAdminPanel(){
  db.ref("users").on("value",s=>{
    let h='<div class="panel"><b>üëë Admin</b><br>';
    s.forEach(c=>{
      if(c.key===user) return;
      const d=c.val();
      h+=`${c.key}
      <button class="smallBtn" onclick="setBan('${c.key}',${!d.banned})">${d.banned?'Unban':'Ban'}</button><br>`;
    });
    h+=`<hr>
    <button onclick="changePin()">Change Reset PIN</button>`;
    adminPanel.innerHTML=h+"</div>";
  });
}
function setBan(u,v){db.ref("users/"+u+"/banned").set(v);}
function changePin(){
  const p=prompt("New Emergency PIN");
  if(p) db.ref("settings/emergencyPin").set(p);
}

/* GROUP ADMIN (FIXED VISIBILITY) */
function loadGroupAdmin(){
  db.ref("groups/"+currentGroup).on("value",s=>{
    const g=s.val();
    if(!g) return;
    const isAdmin=g.admins?.[user]||user===MAIN_ADMIN;
    if(!isAdmin){groupAdmin.innerHTML="";return;}
    let h='<div class="panel"><b>Group Control</b><br>';
    for(let m in g.members){
      if(m===user) continue;
      h+=`${m}
      <button class="smallBtn" onclick="kick('${m}')">Kick</button><br>`;
    }
    groupAdmin.innerHTML=h+"</div>";
  });
}
function kick(u){
  db.ref("groups/"+currentGroup+"/members/"+u).remove();
}

/* MESSAGES */
function loadMessages(){
  if(msgRef) msgRef.off();
  messages.innerHTML="";
  msgRef=db.ref("messages/"+chat).limitToLast(100);

  msgRef.on("child_added",s=>{
    const d=s.val();
    const img=/^https?:\/\/.+\.(png|jpg|jpeg|gif)$/i.test(d.text);
    const canDel=(d.user===user||user===MAIN_ADMIN);
    const li=document.createElement("li");
    li.id=s.key;
    li.innerHTML=`
      <b>${d.user}</b>: ${img?`<img src="${d.text}">`:d.text}
      <span class="time">${new Date(d.time).toLocaleTimeString()}</span>
      ${canDel?`<button class="smallBtn" onclick="deleteMsg('${s.key}')">‚ùå</button>`:""}
    `;
    messages.appendChild(li);
    messages.scrollTop=messages.scrollHeight;
  });

  msgRef.on("child_removed",s=>{
    document.getElementById(s.key)?.remove();
  });
}
function deleteMsg(id){
  db.ref("messages/"+chat+"/"+id).remove();
}

/* RESET */
async function loginEmergencyReset(){
  const pin=(await db.ref("settings/emergencyPin").once("value")).val();
  if(prompt("PIN")!==pin) return;
  await db.ref().remove();
  location.reload();
}
</script>
</body>
</html>
